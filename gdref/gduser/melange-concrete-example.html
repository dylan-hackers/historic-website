<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML
><HEAD
><TITLE
>A Concrete Example</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet version 1.13"><LINK
REL="HOME"
TITLE="Gwydion Dylan User's Guide"
HREF="gduser.html"><LINK
REL="UP"
TITLE="Using the Melange Interface Generator"
HREF="melange.html"><LINK
REL="PREVIOUS"
TITLE="Introduction"
HREF="melange-introduction.html"><LINK
REL="NEXT"
TITLE="Basic Use"
HREF="melange-basic-use.html"></HEAD
><BODY
BGCOLOR="#FFFFFF"
TEXT="#000000"
><DIV
CLASS="NAVHEADER"
><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Gwydion Dylan User's Guide</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="melange-introduction.html"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Chapter 5. Using the Melange Interface Generator</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="melange-basic-use.html"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><H1
><A
NAME="MELANGE-CONCRETE-EXAMPLE"
>A Concrete Example</A
></H1
><P
>In order to get a feel for using Melange, it is probably
      best to start with a concrete example.  This section contains a
      complete program which will use native C libraries to list the
      contents of some directories. For now, you should simply skim
      this example to get a general overview of Melange's
      capabilities. These will be described in more detail in later
      sections.</P
><P
>We will first begin with an "interface file" which
      contains a mixture of basic Dylan code and "define interface"
      forms which will be processed by Melange. We will name this file
      "dirent.intr".</P
><PRE
CLASS="PROGRAMLISTING"
>module: Junk
synopsis: A poor imitation of "ls"

define library junk
  use dylan;
  use streams;
end library junk;

define module junk
  use dylan;
  use extensions;
  use extern;
  use streams;
  use standard-io;
end module junk;

define interface
  // This clause is more complex than it needs to be, but it does
  // demonstrate a lot of Melange's features.
  #include "/usr/include/sys/dirent.h",
    mindy-include-file: "dirent.inc",
    equate: {"char /* Any C declaration is legal */ *" =&#62; &#60;c-string&#62;},
    map: {"char *" =&#62; &#60;byte-string&#62;},
    // The two functions require callbacks, which we don’t support.
    exclude: {"scandir", "alphasort", "struct _dirdesc"},
    seal-functions: open,
    read-only: #t,
    name-mapper: minimal-name-mapping;
  function "opendir", map-argument: {#x1 =&#62; &#60;string&#62;};
  function "telldir" =&#62; tell, map-result: &#60;integer&#62;;
  struct "struct dirent",
    prefix: "dt-",
    exclude: {"d_namlen", "d_reclen"};
end interface;

define method main (program, #rest args)
  for (arg in args)
    let dir = opendir(arg);
    for (entry = readdir(dir) then readdir(dir),
         until entry = $null-pointer)
      write-line(entry.dt-d-name, *standard-output*);
    end for;
    closedir(dir);
  end for;
end method main;</PRE
><P
>We will then process this file through Melange to produce
      a file of pure Dylan code. On a system with <B
CLASS="COMMAND"
>d2c</B
> support, there
      will be an executable named melange, which you can invoke like
      this:

      <PRE
CLASS="SCREEN"
>      <TT
CLASS="USERINPUT"
><B
>melange dirent.intr dirent.dylan</B
></TT
>
      </PRE
>

      On a mindy-only system, where melange is contained in a file
      <TT
CLASS="FILENAME"
>melange.dbc</TT
>, we would use the following
      command line:</P
><PRE
CLASS="SCREEN"
>      <TT
CLASS="USERINPUT"
><B
>mindy -f melange.dbc dirent.intr dirent.dylan</B
></TT
>
      </PRE
><P
>This command will process "melange.intr" and write a file
      named "dirent.dylan". In this case, it will also silently write
      a file named "dirent.inc", whose use will be explained
      later.</P
><P
>You can compile "dirent.dylan" normally, via mindycomp,
      but in order to execute it, you must make sure that the Mindy
      interpreter will be able to load the appropriate routines from
      the library containing the "dirent" routines. Ideally, you would
      simply let Mindy load the appropriate code dynamically. However,
      this is presently only available for a few machines.  Therefore,
      we will follow a messier approach and build a new version of the
      interpreter which is aware of the desired functions.</P
><P
>Move to the build directory for the Mindy interpreter, and
      edit the Makefile so the "EXTERN-INCLUDES" line mentions
      "your_dir_path/dirent.inc" and then run "make mindy". In this
      case, this is all that is required to build a new interpreter
      which is aware of the dirent routines.</P
><P
>You can now put it all together, invoking the new interpreter on
      the compiled program, with:</P
><PRE
CLASS="SCREEN"
>        <TT
CLASS="USERINPUT"
><B
>mindy -f dirent.dbc .</B
></TT
>
      </PRE
><P
>This should print a list of all files in the current
      directory.</P
><P
>Because of the difficulty of relinking the interpreter for
      each new library, it is expected that administrators will build
      a set of "standard" library interfaces which are prelinked into
      the interpreter and exported as general Dylan library
      interfaces. In the future, as Melange (and the Gwydion
      environment) are extended to support better linking and loading
      capabilities, it should become easier to incorporate C libraries
      on an "as-needed" basis.</P
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="melange-introduction.html"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="gduser.html"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="melange-basic-use.html"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Introduction</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="melange.html"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Basic Use</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>