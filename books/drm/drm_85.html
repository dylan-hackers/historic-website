<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  
  <!-- Relative Navigation -->
  
  <link rel="up" href="drm_76.html" />
  <link rel="prev" href="drm_84.html" />
  <link rel="next" href="drm_86.html" />
  
  <!-- Absolute Navigation -->
  
  <link rel="top" href="drm_1.html" />
  <link rel="start first" href="index.html" />
  <link rel="copyright" href="drm_2.html" />
  <link rel="contents" href="drm_3.html" />
  <link rel="glossary" href="drm_126.html" />
  <link rel="index" href="drm_127.html" />
  <link rel="last author" href="drm_128.html" />
  
  <!-- Chapters -->
  
  <link rel="chapter" title="About This Book" href="drm_4.html" />
  <link rel="chapter" title="1 Introduction" href="drm_5.html" />
  <link rel="chapter" title="2 Syntax" href="drm_9.html" />
  <link rel="chapter" title="3 Program Structure" href="drm_25.html" />
  <link rel="chapter" title="4 Program Control" href="drm_28.html" />
  <link rel="chapter" title="5 Types and Classes" href="drm_38.html" />
  <link rel="chapter" title="6 Functions" href="drm_47.html" />
  <link rel="chapter" title="7 Conditions" href="drm_52.html" />
  <link rel="chapter" title="8 Collections" href="drm_59.html" />
  <link rel="chapter" title="9 Sealing" href="drm_70.html" />
  <link rel="chapter" title="10 Macros" href="drm_76.html" />
  <link rel="chapter" title="11 The Built-In Classes" href="drm_87.html" />
  <link rel="chapter" title="12 The Built-In Functions" href="drm_96.html" />
  <link rel="chapter" title="13 Other Built-In Objects" href="drm_108.html" />
  <link rel="chapter" title="14 The Built-In Macros and Special Definitions" href="drm_110.html" />
  
  <!-- Appendices -->
  
  <link rel="appendix" title="A BNF" href="drm_116.html" />
  <link rel="appendix" title="B Exported Names" href="drm_119.html" />
  
  <!-- Stylesheet -->
  
  <link rel="stylesheet" href="drm.css" type="text/css" />

  <title>The Dylan Reference Manual: Hygiene</title>
</head>
<body>

<div id="header">
<div id="navigation-header">
    <p id="book-title">The Dylan Reference Manual</p>
    <p id="basic-navigation"><a class="previous" title="Go to previous page" href="drm_84.html"><img alt="Previous" src="prev.gif" /></a> <a class="next" title="Go to next page" href="drm_86.html"><img alt="Next" src="next.gif" /></a> <a class="up" title="Go to start of chapter" href="drm_76.html"><img alt="Up" src="up.gif" /></a> <a class="start" title="Go to start of book" href="drm_1.html"><img alt="Top" src="top.gif" /></a> <a class="contents" title="Go to table of contents" href="drm_3.html"><img alt="Contents" src="content.gif" /></a> <a class="index" title="Go to index" href="drm_127.html"><img alt="index" src="index.gif" /></a></p>
  </div>

<div id="section-header">
  <p id="section-prefix">Chapter 10</p>
  <p id="section-name">Macros</p>
</div>

<div id="navigation-TOC">
  <ul class="front-matter">
    <li><a href="drm_1.html">Start</a></li>
    <li><a href="drm_3.html">Contents</a></li>
    <li><a href="drm_4.html">About This Book</a></li>
  </ul>
  <ol class="chapters">
    <li><a href="drm_5.html">Introduction</a></li>
    <li><a href="drm_9.html">Syntax</a></li>
    <li><a href="drm_25.html">Program Structure</a></li>
    <li><a href="drm_28.html">Program Control</a></li>
    <li><a href="drm_38.html">Types and Classes</a></li>
    <li><a href="drm_47.html">Functions</a></li>
    <li><a href="drm_52.html">Conditions</a></li>
    <li><a href="drm_59.html">Collections</a></li>
    <li><a href="drm_70.html">Sealing</a></li>
    <li><a href="drm_76.html">Macros</a>
      <ul>
	<li><a href="drm_77.html">Overview</a></li>
	<li><a href="drm_78.html">Extensible Grammar</a></li>
	<li><a href="drm_79.html">Macro Names</a></li>
	<li><a href="drm_80.html">Rewrite Rules</a></li>
	<li><a href="drm_81.html">Patterns</a></li>
	<li><a href="drm_82.html">Pattern Variable Constraints</a></li>
	<li><a href="drm_83.html">Templates</a></li>
	<li><a href="drm_84.html">Auxiliary Rule Sets</a></li>
	<li id="current">Hygiene
	  <ul>
	    <li><a href="#HEADING85-12">Intentional Hygiene Violation</a></li>
	    <li><a href="#HEADING85-15">Hygiene Versus Module Encapsulation</a></li>
	  </ul>
	</li>
	<li><a href="drm_86.html">Rewrite Rule Examples</a></li>
      </ul>
    </li>
    <li><a href="drm_87.html">The Built-In Classes</a></li>
    <li><a href="drm_96.html">The Built-In Functions</a></li>
    <li><a href="drm_108.html">Other Built-In Objects</a></li>
    <li><a href="drm_110.html">The Built-In Macros and Special Definitions</a></li>
  </ol>
  <ol class="appendices">
    <li><a href="drm_116.html">BNF</a></li>
    <li><a href="drm_119.html">Exported Names</a></li>
  </ol>
  <ul class="back-matter">
    <li><a href="drm_126.html">Glossary</a></li>
    <li><a href="drm_127.html">Index</a></li>
    <li><a href="drm_128.html">Colophon</a></li>
  </ul>
  <ul class="errata">
    <li><a href="drm_errata.html">Errata</a></li>
  </ul>
</div>

<hr />

</div>

<div id="content">
<a name="HEADING85-0"></a>
<a name="UID-Macros-1884"></a>
<h1 class="section-title"><a name="MARKER-9-1268"></a>Hygiene</h1>
<p class="T1.Text1"><a name="MARKER-2-1269"></a>Dylan macros are always <dfn>hygienic</dfn>. The basic idea is that each <a name="MARKER-2-1270"></a>named value reference in a macro expansion means the same thing as it meant at the place in the original source code from which it was copied into the macro expansion. This is true whether that place was in the macro definition or in the macro call. Because a macro expansion can include macro calls that need further expansion, named value references in one final expansion can come from several different macro definitions and can come from several different macro calls, either to different macros or&mdash;in the case of recursion&mdash;distinct calls to the same macro.</p>
<p class="T1.Text1">(Sometimes the property that variable references copied from a macro call mean the same thing in the expansion is called "hygiene" and the property that variable references copied from a macro definition mean the same thing in the expansion is called "<a name="MARKER-2-1271"></a>referential transparency."  We include both properties in the term "hygiene.")</p>
<p class="T1.Text1">Specifically, a macro can bind <a name="MARKER-2-1272"></a>temporary variables in its expansion without the risk of accidentally capturing references in the macro call to another binding with the same name. Furthermore, a macro can reference module bindings in its expansion without the risk of those references accidentally being <a name="MARKER-2-1273"></a>captured by bindings of other variables with the same name that surround the macro call. A macro can reference module bindings in its expansion without worrying that the intended bindings might have different names in a module where the macro is called.</p>
<p class="T1.Text1">One way to implement this is for each <var>template-element</var> that is a <em class="BNFCaps">name</em>, <em class="BNFCaps">unary-operator</em>, or <em class="BNFCaps">binary-operator</em> to be replaced in the macro expansion by a special token that plays the same grammatical role as the <em class="BNFCaps">name</em>, <em class="BNFCaps">unary-operator</em>, or <em class="BNFCaps">binary-operator</em> but remembers three pieces of information:</p>
<ul>
  <li>The original <em class="BNFCaps">name</em>. For an operator, this is the name listed in <a href="drm_31.html#MARKER-9-427">Table 4-1 on page 37</a>.</li>
  <li>The lexical context where the macro was defined, which is just a module since macro definitions are only allowed at top level, not inside of bindings.</li>
  <li>The specific macro call occurrence. This could be an integer that is incremented each time a macro expansion occurs.</li>
</ul>
<p class="T1.Text1">In general one cannot know until all macros are expanded whether a <em class="BNFCaps">name</em> is a bound variable reference, a module binding reference, a variable that is being bound, or something that is not a binding name at all, such as a definition <var>modifier</var> or an intermediate word. Similarly, one cannot know until all macros are expanded whether a <em class="BNFCaps">unary-operator</em> or <em class="BNFCaps">binary-operator</em> refers to a local binding or a module binding. Thus the information for each of those cases is retained in the special token. A named value reference and a binding connect if and only if the original <em class="BNFCaps">names</em> and the specific macro call occurrences are both the same. (In that case, the lexical contexts will also be the same, but this need not be checked.)  A named value reference and a binding never connect if one originated in a template and the other originated in a macro call.</p>
<p class="T1.Text1"><a name="MARKER-2-1274"></a>References in a macro expansion to <code>element</code> or <code>aref</code> created by using element reference syntax  must receive similar treatment so the <em class="BNFCaps">name</em> <code>element</code> or <code>aref</code> gets looked up  in the environment of the macro definition, not the environment of the  macro call.</p>
<p class="T1.Text1">For purposes of hygiene, a <var>pattern-keyword default</var> is treated like part of a template, even though it is actually part of a pattern.</p>
<p class="T1.Text1"><a name="MARKER-2-1275"></a>The mapping from getters to setters done by the <code>:=</code> operator is hygienic. In all cases the setter name is looked up in the same lexical context and macro call occurrence as the getter name.</p>
<a name="HEADING85-12"></a>
<a name="UID-Macros-1902"></a>
<h2 class="subsection-title">Intentional Hygiene Violation</h2>
<p class="T1.Text1"><a name="MARKER-2-1276"></a>Sometimes it is necessary for a macro to violate the hygienic property, for example to include in a macro expansion a named value reference to be executed in the lexical context where the macro was called, not the lexical context where the macro was defined. Another example is creating a local binding in a macro expansion that will be visible to the body of the macro. This feature should be used sparingly, as it can be confusing to users of the macro, but sometimes it is indispensable.</p>
<p class="T1.Text1">The construct <code>?=<i class="cv">  <em class="BNFCaps cv">name</em></i></code> in a template inserts into the expansion a reference to <em class="BNFCaps">name</em>, in the lexical context where the macro was called. It is as if <em class="BNFCaps">name</em> came from the macro call rather than from the template.<a name="MARKER-2-1277"></a></p>
<a name="HEADING85-15"></a>
<a name="UID-Macros-1906"></a>
<h2 class="subsection-title">Hygiene Versus Module Encapsulation</h2>
<p class="T1.Text1"><a name="MARKER-2-1278"></a>A named value reference in a macro expansion that was produced by a <var>template-element</var> that is a <em class="BNFCaps">name</em>, <em class="BNFCaps">unary-operator</em>, <em class="BNFCaps">binary-operator</em>, or <code>[</code> <var>template<em><sub>opt</sub></em></var> <code>]</code> and that does not refer to a local binding created by the macro expansion must have the same meaning as would a named value reference with the same name adjacent to the macro definition. This is true even if the macro call is in a different module or a different library from the one in which the macro definition occurs, even if the binding is not exported.</p>
<p class="T1.Text1">This allows exported macros to make use of private bindings without requiring these bindings to be exported for general use. The module that calls the macro does not need to import the private bindings used by the expansion.</p>
<p class="T1.Text1">If one of the following template-element sequences appears in the right-hand side of a rewrite rule, it may introduce named value references to the indicated name in an expansion of the macro. If such a named value reference does not refer to a local binding created by the macro expansion then it must have the same meaning as would a named value reference with the same name adjacent to the macro definition.</p>
<ul>
  <li><var>variable-name</var><br /><br />Reference to <var>variable-name</var></li>
  <li><var>getter-name</var> <code>(</code> <var>template<em><sub>opt</sub></em></var> <code>)</code> <var>assignment-operator</var><br /><var>assignment-operator-name</var> <code>(</code> <var>template<em><sub>opt</sub></em></var> <var>getter-name</var> <code>(</code> <var>template<em><sub>opt</sub></em></var> <code>)</code> <code>)</code><br /><br />Reference to <var>getter-name</var> <code>##</code> <code>&quot;-setter&quot;</code></li>
  <li><code>[</code> <var>template<em><sub>opt</sub></em></var> <code>]</code> <var>assignment-operator</var><br /><var>assignment-operator-name</var> <code>(</code> <var>template<em><sub>opt</sub></em></var> <code>[</code> <var>template<em><sub>opt</sub></em></var> <code>]</code> <code>)</code><br /><br />Reference to either <code>element-setter</code> and <code>aref-setter</code></li>
  <li><code>.</code> <var>getter-name</var> <var>assignment-operator</var><br /><var>assignment-operator-name</var> <code>(</code> <var>template<em><sub>opt</sub></em></var> <code>.</code> <var>getter-name</var> <code>)</code><br /><br />Reference to <var>getter-name</var> <code>##</code> <code>&quot;-setter&quot;</code></li>
  <li><code>define</code> <var>definition-head<em><sub>opt</sub></em></var> <var>definer-name</var><br /><br />Reference to <var>definer-name</var> <code>##</code> <code>&quot;-definer&quot;</code></li>
</ul>
<p class="T1.Text1">Items in the preceding template-element sequences have the following meanings:</p>
<ul class="no-bullet">
  <li>
    <ul>
      <li><var>assignment-operator-name</var> is a <em class="BNFCaps">name</em>, and the value of the binding with that name (in the module containing the macro definition in which the template occurs) is the assignment macro that is the value of the binding named <code>\:= </code>exported by the Dylan module of the Dylan library.</li>
      <li><var>assignment-operator</var> is a binary-operator whose associated binding is an <var>assignment-operator-name</var>.)</li>
      <li><var>definer-name</var> is a <em class="BNFCaps">define-body-word</em> or <em class="BNFCaps">define-list-word</em>.</li>
      <li><var>variable-name</var> and <var>getter-name</var> are <em class="BNFCaps">name</em>s.</li>
      <li><var>template</var> is defined in <a href="drm_116.html">Appendix A, "BNF,"</a> on <a href="drm_118.html#MARKER-9-2121">page 429</a>.</li>
      <li><var>definition-head</var> is defined in <a href="drm_116.html">Appendix A, "BNF,"</a> on <a href="drm_118.html#MARKER-9-2117">page 427</a>.</li>
      <li>The notation <var>foo</var> <code>##</code> <code>&quot;string&quot;</code> indicates a new token composed of the text of <var>foo</var> concatenated with the string.</li>
    </ul>
  </li>
</ul>
<p class="T1.Text1">Note that these template-element sequences can overlap in a template. For example <code>{ foo (bar) := }</code> is a potential reference to <code>foo</code>, to <code>foo-setter</code>, and to <code>bar</code>.</p>
<p class="T1.Text1">Implementations must use some automatic mechanism for noting the bindings associated with the named value references in macro expansions produced by the template-element sequences described above, and must make such bindings available to any library where the macro is accessible. In general, the set of bindings that must be made available to other libraries cannot be computed precisely because the right-hand sides of rewrite rules are not fully parsed until after a macro is called and expanded, making it impossible to determine whether an occurrence of one of the described sequences of template elements will actually produce a named variable reference in the expansion. However, an upper bound on this set of bindings can be computed by assuming that all occurrences of the described template-element sequences might introduce the indicated named value reference if there is a binding for that name accessible from the module in which the macro definition appears.<a name="MARKER-2-1279"></a><a name="MARKER-2-1280"></a></p>

</div>

<div id="footer">

<hr class="footer" />
<address class="footer">The Dylan Reference Manual - 7 Apr 1998</address>
<p class="footer"><a class="previous" title="Go to previous page" href="drm_84.html"><img alt="Previous" src="prev.gif" /></a> <a class="next" title="Go to next page" href="drm_86.html"><img alt="Next" src="next.gif" /></a> <a class="up" title="Go to start of chapter" href="drm_76.html"><img alt="Up" src="up.gif" /></a> <a class="start" title="Go to start of book" href="drm_1.html"><img alt="Top" src="top.gif" /></a> <a class="contents" title="Go to table of contents" href="drm_3.html"><img alt="Contents" src="content.gif" /></a> <a class="index" title="Go to index" href="drm_127.html"><img alt="index" src="index.gif" /></a></p>
<p class="footer">Copyright Apple Computer, Inc. 1996. Apple&#174; and the Apple logo are registered trademarks of Apple Computer, Inc. Used with permission. All Rights Reserved.</p>
<p class="footer">Originally generated with <a href="http://www.harlequin.com/webmaker" class="footer">Harlequin WebMaker&#174;</a>, subsequently revised.</p>

</div>
</body>
</html>
